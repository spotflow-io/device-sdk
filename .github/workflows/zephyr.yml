name: Build Zephyr Project

on:
  push:
    branches:
      - main
    paths:
      - 'zephyr/**'
      - '.github/workflows/zephyr.yml'
  pull_request:
    paths:
      - 'zephyr/**'
      - '.github/workflows/zephyr.yml'

permissions:
  contents: read        # Allows reading repository content (needed for checkout)
  issues: write         # Allows reporting build results to PR checks
  pull-requests: write  # Allows commenting/updating PR status

concurrency:
  group: ${{ github.ref }}-${{ github.workflow }}
  cancel-in-progress: true

jobs:
  generate-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.generate.outputs.matrix }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          sparse-checkout: zephyr/ci/boards.yml
          sparse-checkout-cone-mode: false

      - name: Generate matrix
        id: generate
        run: |
          python3 << 'EOF'
          import yaml
          import json
          import os

          with open('zephyr/ci/boards.yml') as f:
              config = yaml.safe_load(f)

          matrix_entries = []
          for vendor in config['vendors']:
              vendor_props = {
                  'manifest': vendor.get('manifest'),
                  'sdk_version': vendor.get('sdk_version'),
                  'sdk_toolchain': vendor.get('sdk_toolchain'),
                  'blob': vendor.get('blob', ''),
                  'build_extra_args': vendor.get('build_extra_args', '')
              }
              
              for board in vendor['boards']:
                  entry = vendor_props.copy()
                  # Override with board-specific properties
                  for key in entry:
                      if key in board:
                          entry[key] = board[key]
                  # Use id as board if not specified
                  entry['board'] = board.get('board', board['id'])
                  matrix_entries.append(entry)

          matrix_json = json.dumps({'include': matrix_entries})
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f'matrix={matrix_json}\n')
          EOF

  build:
    needs: generate-matrix
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.generate-matrix.outputs.matrix) }}

    steps:
      # Needed to use the hash of the manifest as a part of the cache key
      - name: Checkout manifest
        uses: actions/checkout@v6
        with:
          path: temp-manifest
          sparse-checkout: zephyr/manifests/${{ matrix.manifest }}
          sparse-checkout-cone-mode: false

      - name: Restore workspace dependencies
        id: cache-restore-workspace
        uses: actions/cache/restore@v4
        with:
          path: .
          key: >-
            zephyr-workspace-${{ matrix.manifest }}-
            ${{ hashFiles(format('temp-manifest/zephyr/manifests/{0}', matrix.manifest)) }}-
            ${{ matrix.blob }}-${{ runner.os }}

      - name: Create Python virtual environment
        if: steps.cache-restore-workspace.outputs.cache-hit != 'true'
        run: python -m venv .venv

      - name: Activate Python virtual environment
        run: echo "$GITHUB_WORKSPACE/.venv/bin" >> $GITHUB_PATH

      - name: Install West
        if: steps.cache-restore-workspace.outputs.cache-hit != 'true'
        run: pip install west

      - name: Create workspace
        if: steps.cache-restore-workspace.outputs.cache-hit != 'true'
        run: |
          west init \
            --manifest-url ${{ github.server_url }}/${{ github.repository }} \
            --clone-opt=--revision=${{ github.sha }} \
            --manifest-file zephyr/manifests/${{ matrix.manifest }} \
            .
          west update --fetch-opt=--depth=1 --narrow

      # If west init is skipped thanks to a cache hit, we need to overwrite the outdated version of
      # the Spotflow module restored from the cache by the current commit
      - name: Checkout Spotflow module
        if: steps.cache-restore-workspace.outputs.cache-hit == 'true'
        uses: actions/checkout@v6
        with:
          path: modules/lib/spotflow

      - name: Install Python packages
        if: steps.cache-restore-workspace.outputs.cache-hit != 'true'
        run: west packages pip --install --ignore-venv-check

      - name: Download blobs
        if: steps.cache-restore-workspace.outputs.cache-hit != 'true' && matrix.blob != ''
        run: west blobs fetch ${{ matrix.blob }} --auto-accept

      - name: Cache workspace dependencies
        if: steps.cache-restore-workspace.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: .
          key: >-
            zephyr-workspace-${{ matrix.manifest }}-
            ${{ hashFiles(format('temp-manifest/zephyr/manifests/{0}', matrix.manifest)) }}-
            ${{ matrix.blob }}-${{ runner.os }}

      - name: Cache Zephyr SDK
        id: cache-sdk
        uses: actions/cache@v4
        with:
          path: ~/zephyr-sdk-${{ matrix.sdk_version }}
          key: zephyr-sdk-${{ matrix.sdk_version }}-${{ matrix.sdk_toolchain }}-${{ runner.os }}

      - name: Install SDK
        if: steps.cache-sdk.outputs.cache-hit != 'true'
        run: |
          west sdk install \
            --version ${{ matrix.sdk_version }} \
            --toolchains ${{ matrix.sdk_toolchain }}

      - name: Configure application
        working-directory: modules/lib/spotflow/zephyr/samples/logs
        run: |
          cat <<EOF > credentials.conf
          CONFIG_NET_WIFI_SSID="TODOTODO"
          CONFIG_NET_WIFI_PASSWORD="TODOTODO"
          CONFIG_SPOTFLOW_DEVICE_ID="${{ matrix.board }}_${{ github.run_id }}"
          CONFIG_SPOTFLOW_INGEST_KEY="TODO"
          EOF

      - name: Build application
        working-directory: modules/lib/spotflow/zephyr/samples/logs
        run: |
          west build --board ${{ matrix.board }} ${{ matrix.build_extra_args }}
