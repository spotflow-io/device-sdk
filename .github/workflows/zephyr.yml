name: Build Zephyr Project

on:
  push:
    branches:
      - main
    paths:
      - 'zephyr/**'
      - '.github/workflows/zephyr.yml'
  pull_request:
    paths:
      - 'zephyr/**'
      - '.github/workflows/zephyr.yml'
  workflow_dispatch:
    inputs:
      build_logs_all_boards:
        description: 'Build logging sample for all boards'
        required: false
        type: boolean
        default: false

permissions:
  contents: read        # Allows reading repository content (needed for checkout)
  issues: write         # Allows reporting build results to PR checks
  pull-requests: write  # Allows commenting/updating PR status

concurrency:
  group: ${{ github.ref }}-${{ github.workflow }}
  cancel-in-progress: true

jobs:
  generate-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.generate.outputs.matrix }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          sparse-checkout: |
            zephyr/ci/boards.yml
            zephyr/ci/generate_matrix.py
          sparse-checkout-cone-mode: false

      - name: Generate matrix
        id: generate
        run: >-
          python3 zephyr/ci/generate_matrix.py
          ${{ github.event.inputs.build_logs_all_boards && '--build-logs-for-all-boards' || '' }}

  build:
    needs: generate-matrix
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.generate-matrix.outputs.matrix) }}

    steps:
      # Needed to use the hash of the manifest as a part of the cache key
      - name: Checkout manifest
        uses: actions/checkout@v6
        with:
          path: temp-manifest
          sparse-checkout: zephyr/manifests/${{ matrix.manifest }}
          sparse-checkout-cone-mode: false

      - name: Extract module path from manifest
        id: module-path
        run: |
          python3 << 'EOF'
          import yaml
          import os

          with open('temp-manifest/zephyr/manifests/${{ matrix.manifest }}') as f:
              manifest = yaml.safe_load(f)

          module_path = manifest['manifest']['self']['path']
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f'path={module_path}\n')
          EOF

      - name: Restore workspace dependencies
        id: cache-restore-workspace
        uses: actions/cache/restore@v4
        with:
          path: .
          key: >-
            zephyr-workspace-${{ matrix.manifest }}
            ${{ hashFiles(format('temp-manifest/zephyr/manifests/{0}', matrix.manifest)) }}
            ${{ matrix.blob }}-${{ runner.os }}

      - name: Create Python virtual environment
        if: steps.cache-restore-workspace.outputs.cache-hit != 'true'
        run: python -m venv .venv

      - name: Activate Python virtual environment
        run: echo "$GITHUB_WORKSPACE/.venv/bin" >> $GITHUB_PATH

      - name: Install West
        if: steps.cache-restore-workspace.outputs.cache-hit != 'true'
        run: pip install west

      - name: Create workspace
        if: steps.cache-restore-workspace.outputs.cache-hit != 'true'
        run: |
          west init \
            --manifest-url ${{ github.server_url }}/${{ github.repository }} \
            --clone-opt=--revision=${{ github.sha }} \
            --manifest-file zephyr/manifests/${{ matrix.manifest }} \
            .
          west update --fetch-opt=--depth=1 --narrow

      # If west init is skipped thanks to a cache hit, we need to overwrite the outdated version of
      # the Spotflow module restored from the cache by the current commit
      - name: Checkout Spotflow module
        if: steps.cache-restore-workspace.outputs.cache-hit == 'true'
        uses: actions/checkout@v6
        with:
          path: ${{ steps.module-path.outputs.path }}

      - name: Install Python packages
        if: steps.cache-restore-workspace.outputs.cache-hit != 'true'
        run: west packages pip --install --ignore-venv-check

      - name: Download blobs
        if: steps.cache-restore-workspace.outputs.cache-hit != 'true' && matrix.blob != ''
        run: west blobs fetch ${{ matrix.blob }} --auto-accept

      - name: Cache workspace dependencies
        if: steps.cache-restore-workspace.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: .
          key: >-
            zephyr-workspace-${{ matrix.manifest }}
            ${{ hashFiles(format('temp-manifest/zephyr/manifests/{0}', matrix.manifest)) }}
            ${{ matrix.blob }}-${{ runner.os }}

      - name: Cache Zephyr SDK
        id: cache-sdk
        uses: actions/cache@v4
        with:
          path: ~/zephyr-sdk-${{ matrix.sdk_version }}
          key: zephyr-sdk-${{ matrix.sdk_version }}-${{ matrix.sdk_toolchain }}-${{ runner.os }}

      - name: Install SDK
        if: steps.cache-sdk.outputs.cache-hit != 'true'
        run: |
          west sdk install \
            --version ${{ matrix.sdk_version }} \
            --toolchains ${{ matrix.sdk_toolchain }}

      - name: Configure application
        working-directory: ${{ steps.module-path.outputs.path }}/zephyr/samples/${{ matrix.sample }}
        run: |
          cat <<EOF > credentials.conf
          CONFIG_NET_WIFI_SSID="TODOTODO"
          CONFIG_NET_WIFI_PASSWORD="TODOTODO"
          CONFIG_SPOTFLOW_DEVICE_ID="${{ matrix.board }}_${{ github.run_id }}"
          CONFIG_SPOTFLOW_INGEST_KEY="TODO"
          EOF

      - name: Build application
        working-directory: ${{ steps.module-path.outputs.path }}/zephyr/samples/${{ matrix.sample }}
        run: |
          west build --board ${{ matrix.board }} ${{ matrix.build_extra_args }}
