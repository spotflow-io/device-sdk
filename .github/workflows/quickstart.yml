name: Test and publish Quickstart-related files

on:
  push:
    branches:
      - main
    paths:
      - 'zephyr/ci/**'
      - 'zephyr/manifests/**'
      - '.github/workflows/quickstart.yml'
  pull_request:
    paths:
      - 'zephyr/ci/**'
      - 'zephyr/manifests/**'
      - '.github/workflows/quickstart.yml'

permissions:
  contents: read

concurrency:
  group: ${{ github.ref }}-${{ github.workflow }}
  cancel-in-progress: true

jobs:

  generate-quickstart-json:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Generate quickstart.json
        run: python zephyr/ci/generate_quickstart_json.py

      - name: Upload quickstart.json artifact
        uses: actions/upload-artifact@v4
        with:
          name: quickstart-json
          path: zephyr/ci/quickstart.json

  test-spotflowup:
    needs: generate-quickstart-json
    strategy:
      fail-fast: false
      matrix:
        script: [powershell, bash]
        environment:
          - os: ubuntu-latest
            workspace_dir: test-workspace
            nrfutil_link: x86_64-unknown-linux-gnu/nrfutil
          # Temporarily disabled until fixed
          # - os: macos-latest
          #   workspace_dir: test-workspace
          #   nrfutil_link: universal-apple-darwin/nrfutil
          - os: windows-latest
            workspace_dir: D:\test-workspace
            nrfutil_link: x86_64-pc-windows-msvc/nrfutil.exe
        example:
          - sdk_flag: ncs
            board: nrf7002dk
            board_target: nrf7002dk/nrf5340/cpuapp/ns
            module_path: spotflow
          - sdk_flag: zephyr
            board: frdm_rw612
            board_target: frdm_rw612
            module_path: modules/lib/spotflow
        exclude:
          - script: bash
            environment:
              os: windows-latest

    runs-on: ${{ matrix.environment.os }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Download quickstart.json artifact
        uses: actions/download-artifact@v4
        with:
          name: quickstart-json
          path: ./quickstart-artifact

      - name: Setup and start nginx (Ubuntu)
        if: matrix.environment.os == 'ubuntu-latest'
        run: |
          sudo cp ./quickstart-artifact/quickstart.json /var/www/html/
          sudo systemctl restart nginx
          sleep 2

      - name: Setup and start nginx (Windows)
        if: matrix.environment.os == 'windows-latest'
        shell: pwsh
        run: |
          $nginxPath = "C:\tools\nginx-*"
          $nginxDir = (Get-Item $nginxPath).FullName
          $htmlDir = Join-Path $nginxDir "html"

          Copy-Item ./quickstart-artifact/quickstart.json $htmlDir/

          Start-Process -FilePath (Join-Path $nginxDir "nginx.exe") -WorkingDirectory $nginxDir
          Start-Sleep -Seconds 2

          Write-Host $nginxDir
          $confPath = Join-Path $nginxDir "conf\nginx.conf"
          Write-Host $confPath
          Get-Content $confPath | Write-Host
          Get-ChildItem -Path $htmlDir | Write-Host
          curl -v http://localhost/quickstart.json

      # Windows runner contains Python 3.9, update to the minimum required version
      - name: Install Python
        if: runner.os == 'Windows'
        uses: actions/setup-python@v6
        with:
          python-version: '3.10'

      # Needed for Zephyr SDK installation, not available on Windows runner
      - name: Install wget
        if: runner.os == 'Windows'
        run: choco install wget

      - name: Install nRF Util
        if: matrix.example.sdk_flag == 'ncs'
        shell: pwsh
        run: |
          $baseUrl = "https://files.nordicsemi.com/artifactory/swtools/external/nrfutil/executables"
          $url = "$baseUrl/${{ matrix.environment.nrfutil_link }}"
          if ($IsWindows) {
            $output = "nrfutil.exe"
          } else {
            $output = "nrfutil"
          }

          Write-Host "Downloading nrfutil from $url"
          Invoke-WebRequest -Uri $url -OutFile $output

          if (-not $IsWindows) {
            chmod +x $output
          }

          # Add to PATH for subsequent steps
          $nrfutilDir = (Get-Item $output).DirectoryName
          echo "$nrfutilDir" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

          # Verify installation
          & ./$output --version

      - name: Run spotflowup.ps1
        if: matrix.script == 'powershell'
        shell: pwsh
        run: |
          ./zephyr/ci/spotflowup.ps1 -${{ matrix.example.sdk_flag }} `
            -board ${{ matrix.example.board }} `
            -workspaceFolder ${{ matrix.environment.workspace_dir }} `
            -spotflowRevision ${{ github.sha }} `
            -quickstartJsonUrl "http://localhost/quickstart.json" `
            -autoConfirm

      - name: Run spotflowup.sh
        if: matrix.script == 'bash'
        shell: bash
        run: |
          source ./zephyr/ci/spotflowup.sh --${{ matrix.example.sdk_flag }} \
            --board ${{ matrix.example.board }} \
            --workspace-folder ${{ matrix.environment.workspace_dir }} \
            --spotflow-revision ${{ github.sha }} \
            --quickstart-json-url "http://localhost/quickstart.json" \
            --auto-confirm

      - name: Configure application
        shell: pwsh
        working-directory: ${{ matrix.environment.workspace_dir }}
        run: |
          $configFile = "${{ matrix.example.module_path }}/zephyr/samples/logs/credentials.conf"
          @"
          CONFIG_NET_WIFI_SSID="TODOTODO"
          CONFIG_NET_WIFI_PASSWORD="TODOTODO"
          CONFIG_SPOTFLOW_DEVICE_ID="${{ matrix.example.board }}_${{ github.run_id }}"
          CONFIG_SPOTFLOW_INGEST_KEY="TODO"
          "@ | Set-Content -Path $configFile

      - name: Build Zephyr application
        if: matrix.example.sdk_flag == 'zephyr'
        shell: pwsh
        working-directory: ${{ matrix.environment.workspace_dir }}
        run: |
          # Activate virtual environment
          if ($IsWindows) {
            .venv/Scripts/Activate.ps1
          } else {
            .venv/bin/Activate.ps1
          }

          Set-Location "${{ matrix.example.module_path }}/zephyr/samples/logs"
          west build --board ${{ matrix.example.board_target }}

      - name: Build nRF Connect SDK application
        if: matrix.example.sdk_flag == 'ncs'
        shell: pwsh
        working-directory: ${{ matrix.environment.workspace_dir }}
        run: |
          $ncsVersion = cat nrf/VERSION

          Set-Location "${{ matrix.example.module_path }}/zephyr/samples/logs"
          nrfutil sdk-manager toolchain launch --ncs-version "v$ncsVersion" -- `
            west build --board ${{ matrix.example.board_target }}
